<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anynomous Chat</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.4.7/dist/peerjs.min.js"></script>
</head>
<body>
    <!-- Username Modal -->
    <div id="usernameModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon">
                    <i class="fas fa-user-edit"></i>
                </div>
                <h2>Create Your Identity</h2>
                <p>Choose a unique username to start chatting anonymously</p>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <div class="input-with-icon">
                        <i class="fas fa-at"></i>
                        <input type="text" id="usernameInput" placeholder="Choose username (e.g., shadow_user)" maxlength="20">
                    </div>
                    <div class="input-hint">3-20 characters, letters, numbers, underscores only</div>
                </div>
                <div class="form-group">
                    <div class="input-with-icon">
                        <i class="fas fa-user"></i>
                        <input type="text" id="displayNameInput" placeholder="Display name (optional)" maxlength="30">
                    </div>
                    <div class="input-hint">How others will see you in chats</div>
                </div>
                <div id="usernameError" class="error-message"></div>
            </div>
            <div class="modal-footer">
                <button id="saveUsernameBtn" class="btn btn-primary">
                    <i class="fas fa-check-circle"></i> Continue to Chat
                </button>
            </div>
        </div>
    </div>

    <!-- Main App Container - Initially hidden -->
    <div class="app-container" id="appContainer" style="display: none;">
        <!-- Sidebar (Contacts/Users List) -->
        <div class="sidebar">
            <!-- Sidebar Header -->
            <div class="sidebar-header">
                <div class="app-brand">
                    <div class="brand-icon">
                        <i class="fas fa-user-secret"></i>
                    </div>
                    <h2>Anynomous Chat</h2>
                </div>
                <div class="user-profile">
                    <div class="profile-avatar" id="userAvatar">
                        <img id="userPhoto" src="" alt="Profile">
                        <div class="online-dot"></div>
                    </div>
                    <div class="user-info">
                        <h3 id="userName">Loading...</h3>
                        <p id="userStatus" class="status online">Online</p>
                    </div>
                </div>
                <div class="sidebar-actions">
                    <button id="newChatBtn" class="icon-btn" title="New Chat">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button id="logoutBtn" class="icon-btn" title="Logout">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>

            <!-- Search Bar -->
            <div class="search-bar">
                <div class="search-input">
                    <i class="fas fa-search"></i>
                    <input type="text" id="userSearch" placeholder="Search users by username...">
                    <button id="clearSearch" class="clear-btn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <!-- Users List -->
            <div class="users-list" id="usersList">
                <div class="list-header">
                    <h4><i class="fas fa-users"></i> Online Users</h4>
                    <span id="onlineCount" class="badge">0 online</span>
                </div>
                <div class="list-items" id="contactsList">
                    <!-- Contacts will be loaded here -->
                    <div class="empty-state">
                        <i class="fas fa-search"></i>
                        <p>Search users to start chatting</p>
                    </div>
                </div>
            </div>

            <!-- Active Chats -->
            <div class="chats-list">
                <div class="list-header">
                    <h4><i class="fas fa-comments"></i> Recent Chats</h4>
                </div>
                <div class="list-items" id="chatsList">
                    <!-- Recent chats will be loaded here -->
                    <div class="empty-state">
                        <i class="fas fa-comment-dots"></i>
                        <p>No conversations yet</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="main-content">
            <!-- Chat Header -->
            <div class="chat-header" id="chatHeader">
                <div class="chat-header-default">
                    <div class="chat-welcome">
                        <div class="welcome-icon">
                            <i class="fas fa-user-secret"></i>
                        </div>
                        <div>
                            <h2>Welcome to Anynomous Chat</h2>
                            <p>Select a user to start private messaging</p>
                        </div>
                    </div>
                    <div class="welcome-features">
                        <div class="feature">
                            <i class="fas fa-shield-alt"></i>
                            <span>End-to-End Encrypted</span>
                        </div>
                        <div class="feature">
                            <i class="fas fa-video"></i>
                            <span>Video Calls</span>
                        </div>
                        <div class="feature">
                            <i class="fas fa-file-upload"></i>
                            <span>File Sharing</span>
                        </div>
                    </div>
                </div>
                <div class="chat-header-active" style="display: none;">
                    <div class="chat-partner-info">
                        <div class="partner-avatar">
                            <img id="partnerPhoto" src="" alt="Profile">
                            <div class="partner-status" id="partnerStatusDot"></div>
                        </div>
                        <div class="partner-details">
                            <h3 id="partnerName">...</h3>
                            <p id="partnerStatus" class="status">...</p>
                        </div>
                    </div>
                    <div class="chat-actions">
                        <button id="voiceCallBtn" class="icon-btn btn-call" title="Voice Call">
                            <i class="fas fa-phone"></i>
                        </button>
                        <button id="videoCallBtn" class="icon-btn btn-call" title="Video Call">
                            <i class="fas fa-video"></i>
                        </button>
                        <button class="icon-btn" title="More options">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Messages Container -->
            <div class="messages-container">
                <div class="messages" id="messagesContainer">
                    <div class="empty-chat">
                        <div class="empty-icon">
                            <i class="fas fa-user-secret"></i>
                        </div>
                        <h3>Your private messages appear here</h3>
                        <p>Start a conversation with complete anonymity</p>
                    </div>
                </div>
            </div>

            <!-- Message Input -->
            <div class="message-input-container">
                <div class="input-actions">
                    <button id="attachBtn" class="icon-btn" title="Attach file">
                        <i class="fas fa-paperclip"></i>
                    </button>
                    <button id="emojiBtn" class="icon-btn" title="Emoji">
                        <i class="fas fa-smile"></i>
                    </button>
                    <button id="recordBtn" class="icon-btn" title="Record voice">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <input type="file" id="imageUpload" accept="image/*" style="display: none;">
                    <input type="file" id="audioUpload" accept="audio/*" style="display: none;">
                </div>
                <div class="message-input">
                    <input type="text" id="messageInput" placeholder="Type your secure message..." disabled>
                    <div class="typing-indicator" id="typingIndicator" style="display: none;">
                        <span></span><span></span><span></span>
                    </div>
                </div>
                <button id="sendBtn" class="btn-send" disabled>
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>

        <!-- Call Interface -->
        <div id="callInterface" class="call-interface" style="display: none;">
            <div class="call-container">
                <div class="call-header">
                    <div class="call-icon">
                        <i class="fas fa-phone"></i>
                    </div>
                    <h3 id="callType">Voice Call</h3>
                    <p id="callDuration">00:00</p>
                </div>
                <div class="call-video">
                    <video id="localVideo" autoplay muted playsinline></video>
                    <video id="remoteVideo" autoplay playsinline></video>
                </div>
                <div class="call-controls">
                    <button id="muteBtn" class="call-btn">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <button id="videoToggleBtn" class="call-btn">
                        <i class="fas fa-video"></i>
                    </button>
                    <button id="endCallBtn" class="call-btn end-call">
                        <i class="fas fa-phone-slash"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Incoming Call Modal -->
    <div id="incomingCallModal" class="modal" style="display: none;">
        <div class="modal-content call-modal">
            <div class="modal-header">
                <div class="call-icon incoming">
                    <i class="fas fa-phone"></i>
                </div>
                <h2>Incoming Call</h2>
                <p id="callerName">...</p>
            </div>
            <div class="modal-body">
                <div class="caller-info">
                    <div class="caller-avatar">
                        <img id="callerPhoto" src="" alt="Profile">
                    </div>
                    <p id="callerType" class="call-type">Voice Call</p>
                </div>
            </div>
            <div class="modal-footer call-actions">
                <button id="rejectCallBtn" class="btn btn-danger">
                    <i class="fas fa-phone-slash"></i> Decline
                </button>
                <button id="acceptCallBtn" class="btn btn-success">
                    <i class="fas fa-phone"></i> Accept
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h2>Loading Anynomous Chat</h2>
            <p>Checking authentication...</p>
        </div>
    </div>

    <script>
        // Immediately check auth and redirect if not logged in
        document.addEventListener('DOMContentLoaded', function() {
            // Show loading screen
            const loadingScreen = document.getElementById('loadingScreen');
            if (loadingScreen) {
                loadingScreen.style.display = 'flex';
            }
            
            // Firebase Configuration
            const firebaseConfig = {
                apiKey: "AIzaSyCGHhx35Rd_wl422i6dXARwVLCmhjp11Zg",
                authDomain: "bgmi-tournament-panel.firebaseapp.com",
                databaseURL: "https://bgmi-tournament-panel-default-rtdb.firebaseio.com",
                projectId: "bgmi-tournament-panel",
                storageBucket: "bgmi-tournament-panel.firebasestorage.app",
                messagingSenderId: "531853804076",
                appId: "1:531853804076:web:0be88f13b7c721bc354789"
            };

            // Initialize Firebase
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            
            const auth = firebase.auth();
            
            // Check auth state
            auth.onAuthStateChanged((user) => {
                if (!user) {
                    // User not logged in, redirect to login
                    console.log("User not authenticated, redirecting to login");
                    window.location.href = 'login.html';
                } else {
                    // User is logged in, hide loading screen
                    if (loadingScreen) {
                        loadingScreen.style.display = 'none';
                    }
                    console.log("User authenticated:", user.uid);
                }
            });
        });
    </script>

    <script src="firebase.js"></script>
    <script src="auth.js"></script>
    <script src="chat.js"></script>
    <script src="call.js"></script>
</body>
</html>